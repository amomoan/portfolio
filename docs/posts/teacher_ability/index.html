<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>学力に関する証明書作成アプリ :: YAMAMOTO MASAHIRO</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="「学力に関する証明書」を発行するためにウェブアプリを作成。" />
<meta name="keywords" content=", " />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://amomoan.github.io/portfolio/posts/teacher_ability/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://amomoan.github.io/portfolio/styles.css">







  <link rel="shortcut icon" href="https://amomoan.github.io/portfolio/img/theme-colors/green.png">
  <link rel="apple-touch-icon" href="https://amomoan.github.io/portfolio/img/theme-colors/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="学力に関する証明書作成アプリ">
<meta property="og:description" content="「学力に関する証明書」を発行するためにウェブアプリを作成。" />
<meta property="og:url" content="https://amomoan.github.io/portfolio/posts/teacher_ability/" />
<meta property="og:site_name" content="YAMAMOTO MASAHIRO" />

  
  
  <meta property="og:image" content="https://amomoan.github.io/portfolio/img/gakuryoku.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-07-19 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/portfolio">
  <div class="logo">
    YAMAMOTO MASAHIRO
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/portfolio/about">About</a></li>
        
      
        
          <li><a href="/portfolio/portfolio">Portfolio</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/portfolio/about" >About</a></li>
        
      
        
          <li><a href="/portfolio/portfolio" >Portfolio</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://amomoan.github.io/portfolio/posts/teacher_ability/">学力に関する証明書作成アプリ</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-07-19</time></div>

  
    <span class="post-tags">
      
      #<a href="https://amomoan.github.io/portfolio/tags/python/">Python</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/pandas/">pandas</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/flask/">Flask</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/excel/">Excel</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/sql/">SQL</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AA%E3%82%AA/">ポートフォリオ</a>&nbsp;
      
      #<a href="https://amomoan.github.io/portfolio/tags/%E6%A5%AD%E5%8B%99%E6%94%B9%E5%96%84/">業務改善</a>&nbsp;
      
    </span>
  
  
  <img src="https://amomoan.github.io/portfolio/img/gakuryoku.png"
    class="post-cover"
    alt="学力に関する証明書作成アプリ"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <h2 id="概要">概要<a href="#概要" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>大学には教職課程に関して「学力に関する証明書」という証明書がある。これは文部科学省が様式を公開しており、決まったルールどおりに入力する必要がある。
しかし、入学した年度や各種条件により現行法の科目に読み替える必要がある。</p>
<p>この操作は大変複雑で、かつ、法改正が高頻度であるため、本証明書もそれに対応するため様式を変更する必要がる。とても流動的な証明書である。
多くの大学では、この証明書の発行に多大な労力を払っている。</p>
<p>この証明書を発行するために今までは以下の手順を踏んでいた。</p>
<ol>
<li>成績証明書を出力</li>
<li>当時の講義要項を印刷</li>
<li>読替表を印刷</li>
<li>読替のチェック（蛍光ペンで紙にマーク）</li>
<li>その結果を文部科学省の様式に転記</li>
<li>備考欄に特記事項を記載</li>
</ol>
<p>以上5までのステップはロジカルなものであるため、機械化できると判断した。</p>
<p>当初Excelで完結するつもりだったが、これまでの成績データが 110万件を超えたため断念。
職場の制約を満たすため、成績データや個人情報などはDB化しNASに配置し、ローカルホストでサーバーを立ち上げウェブアプリからDBに接続する方法を採用した。</p>
<p>機密情報があるためすべては公開できないが、上記の5までのステップは1分かからず実行可能。
また、確認資料とできるように生データに近い形をExcelのシートに書き出すように工夫した。
ただし、成績情報が電子データとして保存されている場合に限定される。</p>
<h2 id="効果">効果<a href="#効果" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>現時点ではテンプレートや読替表を整備中のため稼働していないので予測値。</p>
<p>3時間 → 3分程度</p>
<h2 id="ライブラリ">ライブラリ<a href="#ライブラリ" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li><code>openpyxl</code> は、Excel 2010 xlsx/xlsm/xltx/xltmファイルを読み書きするためのPythonライブラリ。</li>
<li><code>pandas</code> は、データ操作と分析のためのPythonライブラリで、データフレームというデータ構造を提供している。</li>
<li><code>flask</code> は、軽量なWSGIウェブアプリケーションフレームワークで、簡単なアプリケーションから複雑なアプリケーションまでスケールアップすることができる。</li>
<li><code>flask_sqlalchemy</code> は、FlaskアプリケーションにSQLAlchemyのサポートを追加する拡張機能。FlaskとSQLAlchemyを使用することを簡単にするために、便利なデフォルトと追加のヘルパーが提供されている。</li>
<li><code>sqlalchemy</code> は、Python SQLツールキットおよびオブジェクト関係マッパーであり、データベースとの対話を容易にする。</li>
<li><code>dotenv</code> は、<code>.env</code> ファイルから環境変数を読み込み、<code>process.env</code> にロードするためのゼロ依存モジュール。コードから環境設定を分離して保存することは、The Twelve-Factor App方法論に基づいている。</li>
</ul>
<h2 id="flask">flask<a href="#flask" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> quote
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> openpyxl
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> (Flask, Response, current_app, flash, g, redirect,
</span></span><span style="display:flex;"><span>                   render_template, request, session)
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask_sqlalchemy <span style="color:#f92672">import</span> SQLAlchemy
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> openpyxl.utils.dataframe <span style="color:#f92672">import</span> dataframe_to_rows
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> text
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.exc <span style="color:#f92672">import</span> SQLAlchemyError
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flaskアプリケーションを作成</span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>load_dotenv()
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>, <span style="color:#e6db74">&#39;for dev&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load_dotenv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>, <span style="color:#e6db74">&#39;for dev&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># データベースファイルのパスを設定</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;DATABASE&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;path/to/sqlite.db&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(<span style="color:#e6db74">&#34;instance/df_db.sqlite&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># データベースURIを設定</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;SQLALCHEMY_DATABASE_URI&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;sqlite:///</span><span style="color:#e6db74">{</span>db_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>df_db <span style="color:#f92672">=</span> SQLAlchemy(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Score</span>(df_db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    student_id <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    student_name <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    birthdate <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    student_affiliation <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    subject_code <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    subject_name <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    evaluation <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    certification_year <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    yomikae_to <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    license_subject <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>    faculty_department <span style="color:#f92672">=</span> df_db<span style="color:#f92672">.</span>Column(df_db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">80</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        student_id,
</span></span><span style="display:flex;"><span>        student_name,
</span></span><span style="display:flex;"><span>        birthdate,
</span></span><span style="display:flex;"><span>        student_affiliation,
</span></span><span style="display:flex;"><span>        subject_code,
</span></span><span style="display:flex;"><span>        subject_name,
</span></span><span style="display:flex;"><span>        evaluation,
</span></span><span style="display:flex;"><span>        certification_year,
</span></span><span style="display:flex;"><span>        yomikae_to,
</span></span><span style="display:flex;"><span>        license_subject,
</span></span><span style="display:flex;"><span>        faculty_department,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>student_id <span style="color:#f92672">=</span> student_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>student_name <span style="color:#f92672">=</span> student_name
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>birthdate <span style="color:#f92672">=</span> birthdate
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>student_affiliation <span style="color:#f92672">=</span> student_affiliation
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>subject_code <span style="color:#f92672">=</span> subject_code
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>subject_name <span style="color:#f92672">=</span> subject_name
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>evaluation <span style="color:#f92672">=</span> evaluation
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>certification_year <span style="color:#f92672">=</span> certification_year
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>yomikae_to <span style="color:#f92672">=</span> yomikae_to
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>license_subject <span style="color:#f92672">=</span> license_subject
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>faculty_department <span style="color:#f92672">=</span> faculty_department
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># データベース接続を取得する関数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_db</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># gオブジェクトにsqlite_db属性がない場合</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> hasattr(g, <span style="color:#e6db74">&#34;sqlite_db&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># データベース接続を作成してgオブジェクトに保存</span>
</span></span><span style="display:flex;"><span>        g<span style="color:#f92672">.</span>sqlite_db <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(current_app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;DATABASE&#34;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データベース接続を返す</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> g<span style="color:#f92672">.</span>sqlite_db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flaskアプリケーションのコンテキスト内でデータベース操作を行う</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> app<span style="color:#f92672">.</span>app_context():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データベースが存在しない場合、データベースとテーブルを作成する</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(db_path):
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>makedirs(<span style="color:#e6db74">&#34;instance&#34;</span>, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> app<span style="color:#f92672">.</span>app_context():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> df_db<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>connect() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>                trans <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>begin()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                    result <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(text(<span style="color:#e6db74">&#34;DROP TABLE score;&#34;</span>))
</span></span><span style="display:flex;"><span>                    trans<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                    trans<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> SQLAlchemyError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred while executing the SQL statement: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データベースとテーブルを作成する。もしなくてもディレクトリごと作成される。</span>
</span></span><span style="display:flex;"><span>    df_db<span style="color:#f92672">.</span>create_all()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># アプリケーションコンテキストが終了するときに呼び出される関数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.teardown_appcontext</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close_db</span>(exception):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># gオブジェクトにsqlite_db属性がある場合</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> hasattr(g, <span style="color:#e6db74">&#34;sqlite_db&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># データベース接続を閉じる</span>
</span></span><span style="display:flex;"><span>        g<span style="color:#f92672">.</span>sqlite_db<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ルートURLにアクセスしたときに呼び出される関数</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> app<span style="color:#f92672">.</span>app_context():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">with</span> df_db<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>connect() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>                trans <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>begin()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                    result <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(text(<span style="color:#e6db74">&#34;DELETE FROM score;&#34;</span>))
</span></span><span style="display:flex;"><span>                    trans<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>                    trans<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> SQLAlchemyError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;An error occurred while executing the SQL statement: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 変数を初期化</span>
</span></span><span style="display:flex;"><span>    student_id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    yomikae_from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    yomikae_to <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    ability <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    belonging <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    yomikae_belonging <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    scores <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    select_columns <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    ability_columns <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    yomikae_belonging_columns <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    db <span style="color:#f92672">=</span> get_db()
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(<span style="color:#e6db74">&#34;SELECT * FROM yomikae LIMIT 1&#34;</span>, db)
</span></span><span style="display:flex;"><span>    select_columns <span style="color:#f92672">=</span> [col <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;\d</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">科目名&#34;</span>, col)]
</span></span><span style="display:flex;"><span>    select_columns<span style="color:#f92672">.</span>sort(reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;SELECT &#34;免許教科&#34; FROM yomikae GROUP BY &#34;免許教科&#34; HAVING &#34;免許教科&#34;!=&#34;教職&#34;&#39;</span>, db
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    ability_columns <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;免許教科&#34;</span>]
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;SELECT &#34;学部学科&#34; FROM yomikae GROUP BY &#34;学部学科&#34; HAVING 学部学科 != &#34;教職教職&#34; ORDER BY &#34;学部学科&#34;&#39;</span>,
</span></span><span style="display:flex;"><span>        db,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    yomikae_belonging_columns <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;学部学科&#34;</span>]
</span></span><span style="display:flex;"><span>    session[<span style="color:#e6db74">&#34;yomikae_to&#34;</span>] <span style="color:#f92672">=</span> yomikae_to
</span></span><span style="display:flex;"><span>    session[<span style="color:#e6db74">&#34;yomikae_from&#34;</span>] <span style="color:#f92672">=</span> yomikae_from
</span></span><span style="display:flex;"><span>    session[<span style="color:#e6db74">&#34;ability&#34;</span>] <span style="color:#f92672">=</span> ability
</span></span><span style="display:flex;"><span>    session[<span style="color:#e6db74">&#34;yomikae_belonging&#34;</span>] <span style="color:#f92672">=</span> yomikae_belonging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># POSTリクエストの場合</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># フォームデータを取得</span>
</span></span><span style="display:flex;"><span>        student_id <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;student_id&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        yomikae_from <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_from&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        yomikae_to <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_to&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        ability <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;ability&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        yomikae_belonging <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_belonging&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;yomikae_to&#34;</span>] <span style="color:#f92672">=</span> yomikae_to
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;yomikae_from&#34;</span>] <span style="color:#f92672">=</span> yomikae_from
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;ability&#34;</span>] <span style="color:#f92672">=</span> ability
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#34;yomikae_belonging&#34;</span>] <span style="color:#f92672">=</span> yomikae_belonging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sSQL <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;学籍番号&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;学生氏名&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;生年月日&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;学生所属&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;科目コード&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;科目名&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;評価&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;認定年度&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                Y.&#34;</span><span style="color:#e6db74">{</span>yomikae_to<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                Y.&#34;免許教科&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                Y.&#34;学部学科&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            FROM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    all_score
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    LEFT JOIN student ON all_score.&#34;学籍番号&#34; = student.&#34;学籍番号&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                ) AS A
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                LEFT JOIN (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span><span style="color:#e6db74">{</span>yomikae_from<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;</span><span style="color:#e6db74">{</span>yomikae_to<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;免許教科&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        &#34;学部学科&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    FROM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        yomikae
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    WHERE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;学部学科&#34; = &#34;</span><span style="color:#e6db74">{</span>yomikae_belonging<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            OR &#34;学部学科&#34; = &#34;教職教職&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        AND
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;免許教科&#34; = &#34;</span><span style="color:#e6db74">{</span>ability<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            OR &#34;免許教科&#34; = &#34;教職&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        AND &#34;</span><span style="color:#e6db74">{</span>yomikae_from<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; IS NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                ) AS Y ON A.&#34;科目名&#34; = REPLACE (Y.&#34;</span><span style="color:#e6db74">{</span>yomikae_from<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;, &#39;●&#39;, &#39;&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            WHERE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                A.&#34;学籍番号&#34; = ?
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># student_idが入力されていない場合</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> student_id:
</span></span><span style="display:flex;"><span>            error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;学籍番号を入力してください。&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># データベース接続を取得</span>
</span></span><span style="display:flex;"><span>            db <span style="color:#f92672">=</span> get_db()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># SQLクエリを実行してデータフレームを取得</span>
</span></span><span style="display:flex;"><span>            df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(sSQL, db, params<span style="color:#f92672">=</span>(student_id,))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> pd<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>DatabaseError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            error <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;データベースエラー: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>sort_values([yomikae_to, <span style="color:#e6db74">&#34;科目コード&#34;</span>])<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># データフレームが空でない場合</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> df<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 氏名と成績データを取得</span>
</span></span><span style="display:flex;"><span>                name <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;学生氏名&#34;</span>]
</span></span><span style="display:flex;"><span>                belonging <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;学生所属&#34;</span>]
</span></span><span style="display:flex;"><span>                columns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;学籍番号&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;学生氏名&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;生年月日&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;学生所属&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;科目コード&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;科目名&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;評価&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;認定年度&#34;</span>,
</span></span><span style="display:flex;"><span>                    yomikae_to,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;免許教科&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;学部学科&#34;</span>,
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>                scores <span style="color:#f92672">=</span> df[columns]<span style="color:#f92672">.</span>to_dict(<span style="color:#e6db74">&#34;records&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> score <span style="color:#f92672">in</span> scores:
</span></span><span style="display:flex;"><span>                    s <span style="color:#f92672">=</span> Score(
</span></span><span style="display:flex;"><span>                        student_id<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;学籍番号&#34;</span>],
</span></span><span style="display:flex;"><span>                        student_name<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;学生氏名&#34;</span>],
</span></span><span style="display:flex;"><span>                        birthdate<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;生年月日&#34;</span>],
</span></span><span style="display:flex;"><span>                        student_affiliation<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;学生所属&#34;</span>],
</span></span><span style="display:flex;"><span>                        subject_code<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;科目コード&#34;</span>],
</span></span><span style="display:flex;"><span>                        subject_name<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;科目名&#34;</span>],
</span></span><span style="display:flex;"><span>                        evaluation<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;評価&#34;</span>],
</span></span><span style="display:flex;"><span>                        certification_year<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;認定年度&#34;</span>],
</span></span><span style="display:flex;"><span>                        yomikae_to<span style="color:#f92672">=</span>score[yomikae_to],
</span></span><span style="display:flex;"><span>                        license_subject<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;免許教科&#34;</span>],
</span></span><span style="display:flex;"><span>                        faculty_department<span style="color:#f92672">=</span>score[<span style="color:#e6db74">&#34;学部学科&#34;</span>],
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                    df_db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(s)
</span></span><span style="display:flex;"><span>                df_db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># テンプレートをレンダリングしてレスポンスを返す</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;index.html&#34;</span>,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span>name,
</span></span><span style="display:flex;"><span>        student_id<span style="color:#f92672">=</span>student_id,
</span></span><span style="display:flex;"><span>        belonging<span style="color:#f92672">=</span>belonging,
</span></span><span style="display:flex;"><span>        yomikae_from<span style="color:#f92672">=</span>yomikae_from,
</span></span><span style="display:flex;"><span>        yomikae_to<span style="color:#f92672">=</span>yomikae_to,
</span></span><span style="display:flex;"><span>        ability<span style="color:#f92672">=</span>ability,
</span></span><span style="display:flex;"><span>        yomikae_belonging<span style="color:#f92672">=</span>yomikae_belonging,
</span></span><span style="display:flex;"><span>        scores<span style="color:#f92672">=</span>scores,
</span></span><span style="display:flex;"><span>        select_columns<span style="color:#f92672">=</span>select_columns,
</span></span><span style="display:flex;"><span>        ability_columns<span style="color:#f92672">=</span>ability_columns,
</span></span><span style="display:flex;"><span>        yomikae_belonging_columns<span style="color:#f92672">=</span>yomikae_belonging_columns,
</span></span><span style="display:flex;"><span>        error<span style="color:#f92672">=</span>error,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/download&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>():
</span></span><span style="display:flex;"><span>    scores <span style="color:#f92672">=</span> Score<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> score <span style="color:#f92672">in</span> scores:
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>append(
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;学籍番号&#34;</span>: score<span style="color:#f92672">.</span>student_id,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;学生氏名&#34;</span>: score<span style="color:#f92672">.</span>student_name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;生年月日&#34;</span>: score<span style="color:#f92672">.</span>birthdate,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;学生所属&#34;</span>: score<span style="color:#f92672">.</span>student_affiliation,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;科目コード&#34;</span>: score<span style="color:#f92672">.</span>subject_code,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;科目名&#34;</span>: score<span style="color:#f92672">.</span>subject_name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;評価&#34;</span>: score<span style="color:#f92672">.</span>evaluation,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;認定年度&#34;</span>: score<span style="color:#f92672">.</span>certification_year,
</span></span><span style="display:flex;"><span>                session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_to&#34;</span>): score<span style="color:#f92672">.</span>yomikae_to,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;免許教科&#34;</span>: score<span style="color:#f92672">.</span>license_subject,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;学部学科&#34;</span>: score<span style="color:#f92672">.</span>faculty_department,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    df_db <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## セッションからデータフレームを取得</span>
</span></span><span style="display:flex;"><span>    template_path <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;xltemplate\tmp.xlsx&#34;</span>
</span></span><span style="display:flex;"><span>    output_sheet_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;output&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ワークブックを読み込む</span>
</span></span><span style="display:flex;"><span>    wb <span style="color:#f92672">=</span> openpyxl<span style="color:#f92672">.</span>load_workbook(template_path)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 出力シートを取得</span>
</span></span><span style="display:flex;"><span>    ws <span style="color:#f92672">=</span> wb[output_sheet_name]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データフレームを行に変換</span>
</span></span><span style="display:flex;"><span>    rows <span style="color:#f92672">=</span> dataframe_to_rows(df_db, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, header<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 行をシートに書き込む</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row_index, row <span style="color:#f92672">in</span> enumerate(rows, <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> column_index, value <span style="color:#f92672">in</span> enumerate(row, <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            ws<span style="color:#f92672">.</span>cell(row<span style="color:#f92672">=</span>row_index, column<span style="color:#f92672">=</span>column_index, value<span style="color:#f92672">=</span>value)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># メモリ上に一時的なバッファを作成</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ワークブックをバッファに保存</span>
</span></span><span style="display:flex;"><span>    wb<span style="color:#f92672">.</span>save(output)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># バッファのデータを取得</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>getvalue()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># レスポンスを作成</span>
</span></span><span style="display:flex;"><span>    studentID <span style="color:#f92672">=</span> str(df_db[<span style="color:#e6db74">&#34;学籍番号&#34;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    student_name <span style="color:#f92672">=</span> str(df_db[<span style="color:#e6db74">&#34;学生氏名&#34;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    filename <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;output_</span><span style="color:#e6db74">{</span>studentID<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>student_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.xlsx&#34;</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> Response(data, content_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;application/vnd.ms-excel&#34;</span>)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;Content-Disposition&#34;</span>, <span style="color:#e6db74">&#34;attachment&#34;</span>, filename<span style="color:#f92672">=</span>quote(filename))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/yomikae&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">yomikae</span>():
</span></span><span style="display:flex;"><span>    db <span style="color:#f92672">=</span> get_db()
</span></span><span style="display:flex;"><span>    yomikae_to <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_to&#34;</span>)
</span></span><span style="display:flex;"><span>    yomikae_from <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_from&#34;</span>)
</span></span><span style="display:flex;"><span>    ability <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;ability&#34;</span>)
</span></span><span style="display:flex;"><span>    yomikae_belonging <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;yomikae_belonging&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># SQLクエリを定義</span>
</span></span><span style="display:flex;"><span>    sSQL <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;SELECT &#34;学部学科&#34;,&#34;免許教科&#34;,&#34;</span><span style="color:#e6db74">{</span>yomikae_from<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#e6db74">{</span>yomikae_to<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; FROM yomikae WHERE &#34;免許教科&#34;=&#34;</span><span style="color:#e6db74">{</span>ability<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; AND &#34;学部学科&#34;=&#34;</span><span style="color:#e6db74">{</span>yomikae_belonging<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># SQLクエリを実行してデータフレームを取得</span>
</span></span><span style="display:flex;"><span>        yomikae_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(sSQL, db)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> pd<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>DatabaseError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># エラー処理</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;データベースエラー: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        yomikae_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>    error <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># テンプレートをレンダリングしてレスポンスを返す</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;yomikae.html&#34;</span>, data<span style="color:#f92672">=</span>yomikae_df<span style="color:#f92672">.</span>to_html(), error<span style="color:#f92672">=</span>error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/import_yomikae&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">import_yomikae</span>():
</span></span><span style="display:flex;"><span>    db_path <span style="color:#f92672">=</span> current_app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;DATABASE&#34;</span>]
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(db_path)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Excelファイルからデータフレームを作成</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_excel(<span style="color:#e6db74">&#34;xltemplate\yomikae.xlsx&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データフレームをデータベースにインポート</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>to_sql(<span style="color:#e6db74">&#34;yomikae&#34;</span>, conn, if_exists<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;replace&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データベース接続を閉じる</span>
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    flash(<span style="color:#e6db74">&#34;取込が完了しました。&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/export_yomikae&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">export_yomikae</span>():
</span></span><span style="display:flex;"><span>    db_path <span style="color:#f92672">=</span> current_app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;DATABASE&#34;</span>]
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(db_path)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># データベースからデータを取得してExcelファイルにエクスポートする処理</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql_query(<span style="color:#e6db74">&#34;SELECT * FROM yomikae&#34;</span>, conn)
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>to_excel(<span style="color:#e6db74">&#34;xltemplate\yomikae.xlsx&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    flash(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;出力が完了しました。&#34;</span>)
</span></span><span style="display:flex;"><span>    flash(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;出力したファイルは \xltemplate\yomikae.xlsx です。&#34;</span>)
</span></span><span style="display:flex;"><span>    flash(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;取り込む際は元の読替表が削除され全件分取り込まれます。&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> index()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># スクリプトとして実行された場合</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Flaskアプリケーションを起動（デバッグモード）</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div>
      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://amomoan.github.io/portfolio/posts/teacher_course_manager/">
                <span class="button__text">教職管理システム</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/portfolio/bundle.min.js"></script>





  
</div>

</body>
</html>
